<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep Research Swarm - Interactive Architecture</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dagre/0.8.5/dagre.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cytoscape-dagre@2.5.0/cytoscape-dagre.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1a1a1a;
            color: #e0e0e0;
            overflow: hidden;
            display: flex;
            height: 100vh;
        }
        #cy {
            flex-grow: 1;
            background-color: #1a1a1a;
            background-image: radial-gradient(#333 1px, transparent 1px);
            background-size: 20px 20px;
        }
        #sidebar {
            width: 350px;
            background-color: #252526;
            border-left: 1px solid #3e3e42;
            padding: 20px;
            box-shadow: -2px 0 10px rgba(0,0,0,0.5);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }
        h1 { font-size: 1.2rem; color: #4fc1ff; margin-top: 0; border-bottom: 1px solid #3e3e42; padding-bottom: 10px; }
        h2 { font-size: 1.5rem; margin-top: 0; color: #fff; }
        .tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .tag.agent { background-color: #2c5d87; color: #9cdcfe; }
        .tag.tool { background-color: #6a4c25; color: #dcdcaa; }
        .tag.data { background-color: #3a503a; color: #b5cea8; }
        .tag.model { background-color: #5a3e5a; color: #c586c0; border: 1px solid #c586c0; }
        
        .section { margin-bottom: 20px; }
        .section-title { font-size: 0.9rem; text-transform: uppercase; color: #808080; margin-bottom: 8px; font-weight: bold; }
        p { line-height: 1.5; font-size: 0.95rem; color: #cccccc; }
        
        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(37, 37, 38, 0.9);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #3e3e42;
            pointer-events: none;
        }
        .legend-item { display: flex; align-items: center; margin-bottom: 5px; font-size: 0.85rem; }
        .dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #424242; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #505050; }

        #details-content { display: none; }
        #details-placeholder { text-align: center; color: #666; margin-top: 50%; }
    </style>
</head>
<body>

    <div id="cy"></div>
    <div class="legend">
        <div class="legend-item"><div class="dot" style="background: #4fc1ff"></div>Agent (Claude Opus 4.5)</div>
        <div class="legend-item"><div class="dot" style="background: #dcdcaa"></div>Tool / External API</div>
        <div class="legend-item"><div class="dot" style="background: #b5cea8"></div>Data / Artifact</div>
        <div class="legend-item"><div class="dot" style="background: #c586c0"></div>Control Flow / Process</div>
    </div>

    <div id="sidebar">
        <h1>System Details</h1>
        <div id="details-placeholder">Select a node to view details</div>
        <div id="details-content">
            <h2 id="node-label">Node Name</h2>
            <div id="node-tags"></div>
            
            <div class="section">
                <div class="section-title">Description</div>
                <p id="node-desc">Description goes here.</p>
            </div>

            <div class="section" id="tools-section">
                <div class="section-title">Available Tools</div>
                <p id="node-tools">List of tools.</p>
            </div>
            
            <div class="section" id="model-section">
                <div class="section-title">AI Model</div>
                <p id="node-model">Model name.</p>
            </div>
        </div>
    </div>

    <script>
        const nodes = [
            // User & Input
            { data: { id: 'user', label: 'User', type: 'user', desc: 'Initiates the research request.' } },
            { data: { id: 'query', label: 'Research Query', type: 'data', desc: 'The natural language question provided by the user.' } },
            
            // Phase 1: Planning
            { data: { id: 'planner', label: 'Planner Agent', type: 'agent', 
                desc: 'Strategies and decomposes complex queries into actionable subtasks.',
                model: 'claude-opus-4-5-20251101',
                tools: 'None (Pure Reasoning)'
            }},
            { data: { id: 'plan', label: 'Research Plan', type: 'data', desc: 'Structured list of subtasks and research strategy.' } },

            // Phase 2: Execution (The Loop)
            { data: { id: 'swarm_controller', label: 'Swarm Controller', type: 'process', desc: 'Orchestrates parallel execution and iteration loops.' } },
            { data: { id: 'workers', label: 'Parallel Workers', type: 'agent', 
                desc: 'Multiple instances running in parallel to execute subtasks.',
                model: 'claude-opus-4-5-20251101',
                tools: 'Perplexity Search, Arxiv, Exa, Scraper'
            }},
            { data: { id: 'tools_ext', label: 'External Tools', type: 'tool', desc: 'Internet Search (Perplexity), Academic DBs (Arxiv), Web Scrapers.' } },
            
            // Knowledge Base
            { data: { id: 'lancedb', label: 'LanceDB (Knowledge Base)', type: 'db', desc: 'Vector database storing all gathered findings, sources, and vectors for semantic search.' } },
            
            // Phase 2b: Critique
            { data: { id: 'critic', label: 'Critic Agent', type: 'agent', 
                desc: 'Evaluates the quality, coverage, and depth of findings.',
                model: 'claude-opus-4-5-20251101',
                tools: 'Read Findings, Analyze Gaps'
            }},
            
            // Phase 3: Experts
            { data: { id: 'experts', label: 'Domain Experts', type: 'agent', 
                desc: 'Panel of specialized personas (Technical, Industry, Skeptic) analyzing findings from different angles.',
                model: 'claude-opus-4-5-20251101',
                tools: 'Knowledge Base Access'
            }},
            
            // Phase 4: Synthesis
            { data: { id: 'editor', label: 'Editor Agent', type: 'agent', 
                desc: 'Synthesizes all findings and expert insights into a final comprehensive report.',
                model: 'claude-opus-4-5-20251101',
                tools: 'File Writer, Markdown Formatter'
            }},
            { data: { id: 'report', label: 'Final Report.md', type: 'data', desc: 'The final Markdown output file.' } },
            
            // Cleanup
            { data: { id: 'cleanup', label: 'DB Cleanup', type: 'process', desc: 'Wipes the LanceDB table after successful report generation.' } }
        ];

        const edges = [
            { data: { source: 'user', target: 'query' } },
            { data: { source: 'query', target: 'planner' } },
            { data: { source: 'planner', target: 'plan', label: 'Generates' } },
            { data: { source: 'plan', target: 'swarm_controller', label: 'Input' } },
            
            { data: { source: 'swarm_controller', target: 'workers', label: 'Spawns (Max 7)' } },
            { data: { source: 'workers', target: 'tools_ext', label: 'Calls' } },
            { data: { source: 'tools_ext', target: 'workers', label: 'Returns Data' } },
            { data: { source: 'workers', target: 'lancedb', label: 'Saves Findings' } },
            
            { data: { source: 'lancedb', target: 'critic', label: 'Reads' } },
            { data: { source: 'critic', target: 'swarm_controller', label: 'Feedback (Loop)' } },
            
            { data: { source: 'swarm_controller', target: 'experts', label: 'If Quality OK' } },
            { data: { source: 'lancedb', target: 'experts', label: 'Context' } },
            { data: { source: 'experts', target: 'lancedb', label: 'Saves Insights' } },
            
            { data: { source: 'experts', target: 'editor', label: 'Handoff' } },
            { data: { source: 'lancedb', target: 'editor', label: 'Full Context' } },
            { data: { source: 'editor', target: 'report', label: 'Writes' } },
            
            { data: { source: 'report', target: 'cleanup', label: 'Triggers' } },
            { data: { source: 'cleanup', target: 'lancedb', label: 'Truncates' } }
        ];

        document.addEventListener('DOMContentLoaded', function() {
            var cy = cytoscape({
                container: document.getElementById('cy'),
                elements: { nodes: nodes, edges: edges },
                style: [
                    {
                        selector: 'node',
                        style: {
                            'label': 'data(label)',
                            'color': '#fff',
                            'text-valign': 'bottom',
                            'text-halign': 'center',
                            'text-margin-y': 8,
                            'font-size': '12px',
                            'width': 50,
                            'height': 50,
                            'border-width': 2,
                            'border-color': '#fff',
                            'overlay-opacity': 0
                        }
                    },
                    {
                        selector: 'node[type="agent"]',
                        style: {
                            'background-color': '#007acc', // VS Code Blue
                            'shape': 'ellipse',
                            'border-color': '#4fc1ff'
                        }
                    },
                    {
                        selector: 'node[type="data"]',
                        style: {
                            'background-color': '#3a503a',
                            'shape': 'round-rectangle',
                            'border-color': '#b5cea8',
                            'width': 40,
                            'height': 40
                        }
                    },
                    {
                        selector: 'node[type="tool"]',
                        style: {
                            'background-color': '#6a4c25',
                            'shape': 'diamond',
                            'border-color': '#dcdcaa'
                        }
                    },
                    {
                        selector: 'node[type="db"]',
                        style: {
                            'background-color': '#8e44ad',
                            'shape': 'barrel', // Cytoscape doesn't have barrel, using cylidner-ish logic or just ellipse
                            'shape': 'ellipse', // Fallback
                            'border-color': '#9b59b6',
                            'width': 60,
                            'height': 60,
                            'label': 'LanceDB'
                        }
                    },
                    {
                        selector: 'node[type="process"]',
                        style: {
                            'background-color': '#333',
                            'shape': 'octagon',
                            'border-color': '#c586c0',
                            'border-style': 'dashed'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 2,
                            'line-color': '#555',
                            'target-arrow-color': '#555',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier',
                            'label': 'data(label)',
                            'font-size': '10px',
                            'color': '#888',
                            'text-rotation': 'autorotate',
                            'text-background-opacity': 1,
                            'text-background-color': '#1a1a1a',
                            'text-background-padding': 3
                        }
                    },
                    {
                        selector: ':selected',
                        style: {
                            'border-width': 4,
                            'border-color': '#fff',
                            'line-color': '#fff',
                            'target-arrow-color': '#fff',
                            'color': '#fff'
                        }
                    }
                ],
                layout: {
                    name: 'dagre',
                    rankDir: 'LR',
                    spacingFactor: 1.2,
                    nodeSep: 50,
                    rankSep: 100
                }
            });

            // Interaction
            cy.on('tap', 'node', function(evt){
                var node = evt.target;
                var data = node.data();
                
                document.getElementById('details-placeholder').style.display = 'none';
                document.getElementById('details-content').style.display = 'block';
                
                document.getElementById('node-label').innerText = data.label;
                document.getElementById('node-desc').innerText = data.desc;
                
                // Tags
                var tagsHtml = '';
                if(data.type) tagsHtml += `<span class="tag ${data.type}">${data.type.toUpperCase()}</span>`;
                document.getElementById('node-tags').innerHTML = tagsHtml;
                
                // Model
                if(data.model) {
                    document.getElementById('model-section').style.display = 'block';
                    document.getElementById('node-model').innerHTML = `<span class="tag model">Claude Opus 4.5</span>`;
                } else {
                    document.getElementById('model-section').style.display = 'none';
                }
                
                // Tools
                if(data.tools) {
                    document.getElementById('tools-section').style.display = 'block';
                    document.getElementById('node-tools').innerText = data.tools;
                } else {
                    document.getElementById('tools-section').style.display = 'none';
                }
            });

            cy.on('tap', function(evt){
                if(evt.target === cy){
                    document.getElementById('details-placeholder').style.display = 'block';
                    document.getElementById('details-content').style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>